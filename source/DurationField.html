<!DOCTYPE html>
<html>
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <title>The source code</title>
  <link href="../resources/prettify/prettify.css" type="text/css" rel="stylesheet" />
  <script type="text/javascript" src="../resources/prettify/prettify.js"></script>
  <style type="text/css">
    .highlight { display: block; background-color: #ddd; }
  </style>
  <script type="text/javascript">
    function highlight() {
      document.getElementById(location.hash.replace(/#/, "")).className = "highlight";
    }
  </script>
</head>
<body onload="prettyPrint(); highlight();">
  <pre class="prettyprint lang-js">/* Copyright (c) 2010, Sage Software, Inc. All rights reserved.
 *
 * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */

define('Sage/Platform/Mobile/Fields/DurationField', [
    'dojo/_base/declare',
    'dojo/string',
    'dojo/dom-class',
    'Sage/Platform/Mobile/Format',
    'Sage/Platform/Mobile/Fields/LookupField',
    'Sage/Platform/Mobile/FieldManager'
], function(
    declare,
    string,
    domClass,
    format,
    LookupField,
    FieldManager
) {
<span id='Sage-Platform-Mobile-Fields-DurationField'>    /**
</span>     *
     */
    var control = declare('Sage.Platform.Mobile.Fields.DurationField', [LookupField], {
<span id='Sage-Platform-Mobile-Fields-DurationField-property-attributeMap'>        attributeMap: {
</span>            inputValue: {
                node: 'inputNode',
                type: 'attribute',
                attribute: 'value'
            },
            inputDisabled: {
                node: 'inputNode',
                type: 'attribute',
                attribute: 'disabled'
            },
            autoCompleteContent: {
                node: 'autoCompleteNode',
                type: 'attribute',
                attribute: 'innerHTML'
            }
        },
<span id='Sage-Platform-Mobile-Fields-DurationField-property-widgetTemplate'>        /**
</span>         * @property {Simplate}
         * Simplate that defines the fields HTML Markup
         *
         * * `$` =&gt; Field instance
         * * `$$` =&gt; Owner View instance
         *
         */
        widgetTemplate: new Simplate([
            '&lt;label for=&quot;{%= $.name %}&quot;&gt;{%: $.label %}&lt;/label&gt;',
            '&lt;div class=&quot;autoComplete-watermark&quot; data-dojo-attach-point=&quot;autoCompleteNode&quot;&gt;&lt;/div&gt;',
            '&lt;button class=&quot;button simpleSubHeaderButton&quot; data-dojo-attach-event=&quot;onclick:navigateToListView&quot; aria-label=&quot;{%: $.lookupLabelText %}&quot;&gt;&lt;span aria-hidden=&quot;true&quot;&gt;{%: $.lookupText %}&lt;/span&gt;&lt;/button&gt;',
            '&lt;input data-dojo-attach-point=&quot;inputNode&quot; data-dojo-attach-event=&quot;onkeyup: _onKeyUp, onblur: _onBlur, onfocus: _onFocus&quot; class=&quot;text-input&quot; type=&quot;{%: $.inputType %}&quot; name=&quot;{%= $.name %}&quot; {% if ($.readonly) { %} readonly {% } %}&gt;'
        ]),

<span id='Sage-Platform-Mobile-Fields-DurationField-property-emptyText'>        // Localization
</span>        emptyText: '',
<span id='Sage-Platform-Mobile-Fields-DurationField-property-invalidDurationErrorText'>        invalidDurationErrorText: &quot;Field '${0}' is not a valid duration.&quot;,
</span><span id='Sage-Platform-Mobile-Fields-DurationField-property-autoCompleteText'>        autoCompleteText: {
</span>            'minute(s)': 1,
            'hour(s)': 60,
            'day(s)': 1440,
            'week(s)': 10080,
            'year(s)': 525960
        },

<span id='Sage-Platform-Mobile-Fields-DurationField-property-valueKeyProperty'>        valueKeyProperty: false,
</span><span id='Sage-Platform-Mobile-Fields-DurationField-property-valueTextProperty'>        valueTextProperty: false,
</span><span id='Sage-Platform-Mobile-Fields-DurationField-property-currentKey'>        currentKey: null,
</span><span id='Sage-Platform-Mobile-Fields-DurationField-property-currentValue'>        currentValue: 0,
</span>
<span id='Sage-Platform-Mobile-Fields-DurationField-property-autoCompletePhraseRE'>        /**
</span>         * The first capture group must be non-text part
         * Second capture is the phrase to be used in auto complete
         */
        autoCompletePhraseRE: /^((?:\d+(?:\.\d*)?|\.\d+)\s*?)(\w+)/,

<span id='Sage-Platform-Mobile-Fields-DurationField-property-autoCompleteValueRE'>        /**
</span>         * Only one capture which should correlate to the value portion
         */
        autoCompleteValueRE: /^((?:\d+(?:\.\d*)?|\.\d+))/,
        
<span id='Sage-Platform-Mobile-Fields-DurationField-method-init'>        init: function() {
</span>            // do not use lookups connects

            var numberDecimalSeparator = Mobile.CultureInfo.numberFormat.numberDecimalSeparator;

            this.autoCompletePhraseRE = new RegExp(
                string.substitute('^((?:\\d+(?:\\${0}\\d*)?|\\${0}\\d+)\\s*?)(\\w+)', [numberDecimalSeparator])
            );

            this.autoCompleteValueRE = new RegExp(
                string.substitute('^((?:\\d+(?:\\${0}\\d*)?|\\${0}\\d+))', [numberDecimalSeparator])
            );
        },
<span id='Sage-Platform-Mobile-Fields-DurationField-method-_onKeyUp'>        _onKeyUp: function(evt) {
</span>            var val = this.inputNode.value.toString(),
                match = this.autoCompletePhraseRE.exec(val);

            if (!match || val.length &lt; 1)
            {
                this.hideAutoComplete();
                return true;
            }

            for (var key in this.autoCompleteText)
            {
                if (this.isWordMatch(match[2], key))
                {
                    this.currentKey = key;
                    this.showAutoComplete(match[1] + key);
                    return true;
                }
            }

            this.hideAutoComplete();
        },
<span id='Sage-Platform-Mobile-Fields-DurationField-method-isWordMatch'>        isWordMatch: function(val, word) {
</span>            if (val.length &gt; word.length)
                val = val.slice(0, word.length);
            else
                word = word.slice(0, val.length);

            return val.toUpperCase() === word.toUpperCase();
        },
<span id='Sage-Platform-Mobile-Fields-DurationField-method-showAutoComplete'>        showAutoComplete: function(word) {
</span>            this.set('autoCompleteContent', word);
        },
<span id='Sage-Platform-Mobile-Fields-DurationField-method-hideAutoComplete'>        hideAutoComplete: function() {
</span>            this.set('autoCompleteContent', '');
        },
<span id='Sage-Platform-Mobile-Fields-DurationField-method-_onBlur'>        _onBlur: function(evt) {
</span>            var val = this.inputNode.value.toString(),
                match = this.autoCompleteValueRE.exec(val),
                multiplier = this.autoCompleteText[this.currentKey],
                newValue = 0;

            if (val.length &lt; 1) return true;
            if (!match) return true;

            newValue = parseFloat(match[0]) * multiplier;
            this.setValue(newValue);
        },
<span id='Sage-Platform-Mobile-Fields-DurationField-method-getValue'>        getValue: function(){
</span>            return this.currentValue;
        },
<span id='Sage-Platform-Mobile-Fields-DurationField-method-setValue'>        setValue: function(val, init) {
</span>            this.currentValue = val;
            this.set('inputValue', this.textFormat(val));
            this.hideAutoComplete();
        },
<span id='Sage-Platform-Mobile-Fields-DurationField-method-setSelection'>        setSelection: function(val, key) {
</span>            this.setValue(parseFloat(key));
        },
<span id='Sage-Platform-Mobile-Fields-DurationField-method-textFormat'>        textFormat: function(val) {
</span>            var stepValue,
                finalUnit = 1,
                autoCompleteValues = this.autoCompleteText;

            for (var key in autoCompleteValues)
            {
                stepValue = autoCompleteValues[key];
                if (val === 0 &amp;&amp; stepValue === 1)
                {
                    this.currentKey = key;
                    break;
                }
                if (val / stepValue &gt;= 1)
                {
                    finalUnit = stepValue;
                    this.currentKey = key;
                }
            }
            return this.convertUnit(val, finalUnit) + ' ' +this.currentKey;
        },
<span id='Sage-Platform-Mobile-Fields-DurationField-method-convertUnit'>        convertUnit: function(val, to) {
</span>            return format.fixed(val/to, 2);
        },
<span id='Sage-Platform-Mobile-Fields-DurationField-method-createNavigationOptions'>        createNavigationOptions: function() {
</span>            var options = this.inherited(arguments);
            options.hideSearch = true;
            options.data = this.expandExpression(this.data);
            return options;
        },
<span id='Sage-Platform-Mobile-Fields-DurationField-method-validate'>        validate: function() {
</span>            var val = this.inputNode.value.toString(),
                phraseMatch = this.autoCompletePhraseRE.exec(val);

            if (!phraseMatch)
            {
               domClass.add(this.containerNode, 'row-error');
               return string.substitute(this.invalidDurationErrorText, [val]);
            }
            else
            {
               domClass.remove(this.containerNode, 'row-error');
               return false;
            }
        }
    });
    
    return FieldManager.register('duration', control);
});</pre>
</body>
</html>
