<!DOCTYPE html>
<html>
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <title>The source code</title>
  <link href="../resources/prettify/prettify.css" type="text/css" rel="stylesheet" />
  <script type="text/javascript" src="../resources/prettify/prettify.js"></script>
  <style type="text/css">
    .highlight { display: block; background-color: #ddd; }
  </style>
  <script type="text/javascript">
    function highlight() {
      document.getElementById(location.hash.replace(/#/, "")).className = "highlight";
    }
  </script>
</head>
<body onload="prettyPrint(); highlight();">
  <pre class="prettyprint lang-js">/* Copyright (c) 2010, Sage Software, Inc. All rights reserved.
 *
 * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */

<span id='argos-Views-DateTimePicker'>/**
</span> * DateTimePicker View.
 * @alternateClassName DateTimePicker
 * @extends View
 * @mixins _TemplatedWidgetMixin
 */
define('argos/Views/DateTimePicker', [
    'dojo/_base/declare',
    'dojo/string',
    'dojo/dom-attr',
    'dojo/dom-class',
    'dojo/dom-construct',
    'dojo/dom-style',
    '../_TemplatedWidgetMixin',
    '../View'
], function(
    declare,
    string,
    domAttr,
    domClass,
    domConstruct,
    domStyle,
    _TemplatedWidgetMixin,
    View
) {
    var pad = function(n) { return n &lt; 10 ? '0' + n : n; };
    var uCase = function (str) { return str.charAt(0).toUpperCase() + str.substring(1); };

    return declare('argos.Views.DateTimePicker', [View, _TemplatedWidgetMixin], {
<span id='argos-Views-DateTimePicker-property-titleText'>        // Localization
</span>        titleText: 'Date',
<span id='argos-Views-DateTimePicker-property-amText'>        amText: 'AM',
</span><span id='argos-Views-DateTimePicker-property-pmText'>        pmText: 'PM',
</span>
<span id='argos-Views-DateTimePicker-property-id'>        id: 'datetimepicker',
</span><span id='argos-Views-DateTimePicker-property-events'>        events: {
</span>            'click': true
        },
<span id='argos-Views-DateTimePicker-property-tier'>        tier: 0,
</span><span id='argos-Views-DateTimePicker-property-contentNode'>        contentNode: null,
</span><span id='argos-Views-DateTimePicker-property-calendarNode'>        calendarNode: null,
</span><span id='argos-Views-DateTimePicker-property-timeNode'>        timeNode: null,
</span><span id='argos-Views-DateTimePicker-property-meridiemNode'>        meridiemNode: null,
</span><span id='argos-Views-DateTimePicker-property-monthsShortText'>        monthsShortText: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'],
</span><span id='argos-Views-DateTimePicker-property-dateFormat'>        dateFormat: moment.longDateFormat.L,
</span><span id='argos-Views-DateTimePicker-property-timeFormatText'>        timeFormatText: 'h:mm A',
</span><span id='argos-Views-DateTimePicker-property-is24hrTimeFormat'>        is24hrTimeFormat: moment.longDateFormat.LT.match(/H\:/),
</span><span id='argos-Views-DateTimePicker-property-date'>        date: false,
</span><span id='argos-Views-DateTimePicker-property-showTimePicker'>        showTimePicker: false,
</span><span id='argos-Views-DateTimePicker-property-timeless'>        timeless: false,
</span><span id='argos-Views-DateTimePicker-property-selectorTemplate'>        selectorTemplate:  '&lt;select id=&quot;${0}-field&quot; data-dojo-attach-point=&quot;${0}Node&quot;&gt;&lt;/select&gt;',
</span><span id='argos-Views-DateTimePicker-property-incrementTemplate'>        incrementTemplate: '&lt;button data-action=&quot;increment${0}&quot; class=&quot;button&quot;&gt;+&lt;/button&gt;',
</span><span id='argos-Views-DateTimePicker-property-decrementTemplate'>        decrementTemplate: '&lt;button data-action=&quot;decrement${0}&quot; class=&quot;button&quot;&gt;-&lt;/button&gt;',
</span><span id='argos-Views-DateTimePicker-property-widgetTemplate'>        widgetTemplate: new Simplate([
</span>            '&lt;div id=&quot;{%= $.id %}&quot; title=&quot;{%: $.titleText %}&quot; class=&quot;panel {%= $.cls %}&quot;&gt;',
                '&lt;div class=&quot;panel-content datetime-picker&quot;&gt;',
                    '&lt;div class=&quot;calendar-content&quot;&gt;',
                    '&lt;table id=&quot;datetime-picker-date&quot; data-dojo-attach-point=&quot;datePickControl&quot;&gt;',
                        '&lt;caption&gt;&amp;nbsp;&lt;/caption&gt;',
                        '&lt;tr class=&quot;plus&quot;&gt;',
                            '&lt;td&gt;{%= $.localizeViewTemplate(&quot;incrementTemplate&quot;, 0) %}&lt;/td&gt;',
                            '&lt;td&gt;{%= $.localizeViewTemplate(&quot;incrementTemplate&quot;, 1) %}&lt;/td&gt;',
                            '&lt;td&gt;{%= $.localizeViewTemplate(&quot;incrementTemplate&quot;, 2) %}&lt;/td&gt;',
                        '&lt;/tr&gt;',
                        '&lt;tr class=&quot;datetime-selects&quot;&gt;',
                            '&lt;td&gt;{%= $.localizeViewTemplate(&quot;selectorTemplate&quot;, 0) %}&lt;/td&gt;',
                            '&lt;td&gt;{%= $.localizeViewTemplate(&quot;selectorTemplate&quot;, 1) %}&lt;/td&gt;',
                            '&lt;td&gt;{%= $.localizeViewTemplate(&quot;selectorTemplate&quot;, 2) %}&lt;/td&gt;',
                        '&lt;/tr&gt;',
                        '&lt;tr class=&quot;minus&quot;&gt;',
                            '&lt;td&gt;{%= $.localizeViewTemplate(&quot;decrementTemplate&quot;, 0) %}&lt;/td&gt;',
                            '&lt;td&gt;{%= $.localizeViewTemplate(&quot;decrementTemplate&quot;, 1) %}&lt;/td&gt;',
                            '&lt;td&gt;{%= $.localizeViewTemplate(&quot;decrementTemplate&quot;, 2) %}&lt;/td&gt;',
                        '&lt;/tr&gt;',
                    '&lt;/table&gt;',
                    '&lt;/div&gt;',
                    '&lt;div class=&quot;time-content&quot; data-dojo-attach-point=&quot;timeNode&quot;&gt;',
                        '&lt;table id=&quot;datetime-picker-time&quot; data-dojo-attach-point=&quot;timePickControl&quot;&gt;',
                            '&lt;caption&gt;&amp;nbsp;&lt;/caption&gt;',
                            '&lt;tr class=&quot;plus&quot;&gt;',
                                '&lt;td&gt;{%= $.localizeViewTemplate(&quot;incrementTemplate&quot;, 3) %}&lt;/td&gt;',
                                '&lt;td&gt;{%= $.localizeViewTemplate(&quot;incrementTemplate&quot;, 4) %}&lt;/td&gt;',
                                '&lt;td rowspan=&quot;3&quot;&gt;',
                                    '&lt;div class=&quot;toggle toggle-vertical meridiem-field&quot; data-action=&quot;toggleMeridiem&quot; data-dojo-attach-point=&quot;meridiemNode&quot;&gt;',
                                        '&lt;span class=&quot;thumb vertical&quot;&gt;&lt;/span&gt;',
                                        '&lt;span class=&quot;toggleOn&quot;&gt;{%= $.amText %}&lt;/span&gt;',
                                        '&lt;span class=&quot;toggleOff&quot;&gt;{%= $.pmText %}&lt;/span&gt;',
                                    '&lt;/div&gt;',
                                '&lt;/td&gt;',
                            '&lt;/tr&gt;',
                            '&lt;tr class=&quot;datetime-selects&quot;&gt;',
                                '&lt;td&gt;{%= $.localizeViewTemplate(&quot;selectorTemplate&quot;, 3) %}&lt;/td&gt;',
                                '&lt;td&gt;{%= $.localizeViewTemplate(&quot;selectorTemplate&quot;, 4) %}&lt;/td&gt;',
                            '&lt;/tr&gt;',
                            '&lt;tr class=&quot;minus&quot;&gt;',
                                '&lt;td&gt;{%= $.localizeViewTemplate(&quot;decrementTemplate&quot;, 3) %}&lt;/td&gt;',
                                '&lt;td&gt;{%= $.localizeViewTemplate(&quot;decrementTemplate&quot;, 4) %}&lt;/td&gt;',
                            '&lt;/tr&gt;',
                        '&lt;/table&gt;',
                    '&lt;/div&gt;',
                    '&lt;div style=&quot;clear:both&quot;&gt;&lt;/div&gt;',
                '&lt;/div&gt;',
            '&lt;/div&gt;'
        ]),

<span id='argos-Views-DateTimePicker-property-dayNode'>        dayNode: null,
</span><span id='argos-Views-DateTimePicker-property-monthNode'>        monthNode: null,
</span><span id='argos-Views-DateTimePicker-property-yearNode'>        yearNode: null,
</span><span id='argos-Views-DateTimePicker-property-hourNode'>        hourNode: null,
</span><span id='argos-Views-DateTimePicker-property-minuteNode'>        minuteNode: null,
</span><span id='argos-Views-DateTimePicker-property-datePickControl'>        datePickControl: null,
</span><span id='argos-Views-DateTimePicker-property-timePickControl'>        timePickControl: null,
</span>
<span id='argos-Views-DateTimePicker-method-daysInMonth'>        daysInMonth: function() {
</span>            return moment(this.year + '-' + (1 + 1 * this.month) + '-01').daysInMonth();
        },
<span id='argos-Views-DateTimePicker-method-startup'>        startup: function() {
</span>            this.inherited(arguments);

            this.connect(this.dayNode,    'onchange', this.validate);
            this.connect(this.monthNode,  'onchange', this.validate);
            this.connect(this.yearNode,   'onchange', this.validate);
            this.connect(this.hourNode,   'onchange', this.validate);
            this.connect(this.minuteNode, 'onchange', this.validate);
        },

<span id='argos-Views-DateTimePicker-method-validate'>        validate: function() {
</span>            this.year = this.yearNode.value;
            this.month = this.monthNode.value;

            // adjust dayNode selector from changes to monthNode or leap/non-leap year
            if (this.dayNode.options.length != this.daysInMonth())
            {
                this.populateSelector(this.dayNode, this.dayNode.selectedIndex + 1, 1, this.daysInMonth());
            }

            this.date = moment(new Date(this.year, this.month, this.dayNode.value));
            var isPM = this.is24hrTimeFormat ? (11 &lt; this.hourNode.value) : domAttr.get(this.meridiemNode, 'toggled') !== true,
                hours = parseInt(this.hourNode.value, 10),
                minutes = parseInt(this.minuteNode.value, 10);
            hours = isPM ? (hours % 12) + 12 : (hours % 12);
            this.date.hours(hours);
            this.date.minutes(minutes);

            this.updateDatetimeCaption();
        },
<span id='argos-Views-DateTimePicker-method-toggleMeridiem'>        toggleMeridiem: function(params) {
</span>            var el = params.$source,
                toggledValue = el &amp;&amp; (domAttr.get(el, 'toggled') !== true);

            if (el)
            {
                domClass.toggle(el, 'toggleStateOn');
                domAttr.set(el, 'toggled', toggledValue);
            }

            this.updateDatetimeCaption();
        },
<span id='argos-Views-DateTimePicker-method-populateSelector'>        populateSelector: function(el, val, min, max) {
</span>            if (val &gt; max) { val = max; }
            el.options.length = 0;

            for (var i=min; i &lt;= max; i++)
            {
                var opt = domConstruct.create('option', {
                    innerHTML: (this.monthNode == el) ? uCase(this.monthsShortText[i]) : pad(i),
                    value: i,
                    selected: (i == val)
                });
                el.options[el.options.length] = opt;
            }
        },
<span id='argos-Views-DateTimePicker-method-localizeViewTemplate'>        localizeViewTemplate: function() {
</span>            var whichTemplate = arguments[0],
                formatIndex = arguments[1],
                fields = { y:'year', Y:'year', M:'month', d:'day', D:'day', h:'hour', H:'hour', m:'minute' };

            var whichField = fields[ (3 &gt; formatIndex)
                ? moment.longDateFormat.L.split(/[^a-z]/i)[formatIndex].charAt(0)
                : this.timeFormatText.split(/[^a-z]/i)[formatIndex - 3].charAt(0)
                ];

            var whichFormat = ('selectorTemplate' == whichTemplate)
                ? whichField
                : uCase(whichField);

            return string.substitute(this[whichTemplate], [whichFormat]);
        },
<span id='argos-Views-DateTimePicker-method-activate'>        activate: function(options) {
</span>            this.inherited(arguments);

            this.titleText = options.label ? options.label : this.titleText;

            this.showTimePicker = this.options &amp;&amp; this.options.showTimePicker;

            this.date  = moment((this.options &amp;&amp; this.options.date) || moment());
            this.year  = this.date.year();
            this.month = this.date.month();

            if ((this.options &amp;&amp; this.options.timeless) || this.timeless)
                this.date.add({minutes: this.date.zone()});

            var today = moment();

            this.populateSelector(this.yearNode, this.year,
                    (this.year &lt; today.year()) - 10 ? this.year : today.year() - 10, // min 10 years in past - arbitrary min
                    (10 + today.year()) // max 10 years into future - arbitrary limit
            );
            this.populateSelector(this.monthNode, this.month, 0, 11);
            this.populateSelector(this.dayNode, this.date.date(), 1, this.daysInMonth());
            this.populateSelector(this.hourNode,
                this.date.hours() &gt; 12 &amp;&amp; !this.is24hrTimeFormat
                    ? this.date.hours() - 12
                    : (this.date.hours() || 12),
                this.is24hrTimeFormat ? 0 : 1,
                this.is24hrTimeFormat ? 23 : 12
            );
            this.populateSelector(this.minuteNode, this.date.minutes(), 0, 59);

            if (this.date.hours() &lt; 12)
            {
                domAttr.set(this.meridiemNode, 'toggled', true);
                domClass.add(this.meridiemNode, 'toggleStateOn');
            }
            else
            {
                domAttr.set(this.meridiemNode, 'toggled', false);
                domClass.remove(this.meridiemNode, 'toggleStateOn');
            }


            this.updateDatetimeCaption();

            if (this.showTimePicker) {
                domClass.remove(this.timeNode, 'time-content-hidden');
                // hide meridiem toggle when using 24hr time format:
                if (this.is24hrTimeFormat) { domStyle.set(this.meridiemNode.parentNode, 'display', 'none'); }
            } else {
                domClass.add(this.timeNode, 'time-content-hidden');
            }
        },

<span id='argos-Views-DateTimePicker-method-decrementYear'>        decrementYear: function() {
</span>            this.decrement(this.yearNode);
        },
<span id='argos-Views-DateTimePicker-method-decrementMonth'>        decrementMonth: function() {
</span>            this.decrement(this.monthNode);
        },
<span id='argos-Views-DateTimePicker-method-decrementDay'>        decrementDay: function() {
</span>            this.decrement(this.dayNode);
        },
<span id='argos-Views-DateTimePicker-method-decrementHour'>        decrementHour: function() {
</span>            this.decrement(this.hourNode);
            if (11 == this.hourNode.value % 12)
            {
                this.toggleMeridiem({$source:this.meridiemNode});
            }
        },
<span id='argos-Views-DateTimePicker-method-decrementMinute'>        decrementMinute: function() {
</span>            this.decrement(this.minuteNode, 15);
        },
<span id='argos-Views-DateTimePicker-method-decrement'>        decrement: function(el, inc) { // all fields are &lt;select&gt; elements
</span>            inc = inc || 1;

            if (0 &lt;= (el.selectedIndex - inc))
            {
                el.selectedIndex = inc * Math.floor((el.selectedIndex -1)/ inc);
            }
            else
            {
                if (el == this.yearNode)   { return false; }
                if (el == this.dayNode)    { this.decrementMonth(); }
                if (el == this.monthNode)  { this.decrementYear();  }
                if (el == this.minuteNode) { this.decrementHour();  }
                el.selectedIndex = el.options.length - inc;
            }

            this.validate(null, el);
        },

<span id='argos-Views-DateTimePicker-method-incrementYear'>        incrementYear: function() {
</span>            this.increment(this.yearNode);
        },
<span id='argos-Views-DateTimePicker-method-incrementMonth'>        incrementMonth: function() {
</span>            this.increment(this.monthNode);
        },
<span id='argos-Views-DateTimePicker-method-incrementDay'>        incrementDay: function() {
</span>            this.increment(this.dayNode);
        },
<span id='argos-Views-DateTimePicker-method-incrementHour'>        incrementHour: function() {
</span>            this.increment(this.hourNode);

            if (this.hourNode.selectedIndex == (this.hourNode.options.length - 1))
            {
                this.toggleMeridiem({$source:this.meridiemNode});
            }
        },
<span id='argos-Views-DateTimePicker-method-incrementMinute'>        incrementMinute: function() {
</span>            this.increment(this.minuteNode, 15);
        },
<span id='argos-Views-DateTimePicker-method-increment'>        increment: function(el, inc) {
</span>            inc = inc || 1;

            if (el.options.length &gt; (el.selectedIndex + inc))
            {
                el.selectedIndex += inc;
            }
            else
            {
                if (el == this.yearNode) { return false; }
                if (el == this.dayNode) { this.incrementMonth(); }
                if (el == this.monthNode)  { this.incrementYear(); }
                if (el == this.minuteNode) { this.incrementHour(); }
                el.selectedIndex = 0;
            }

            this.validate(null, el);
        },
<span id='argos-Views-DateTimePicker-method-updateDatetimeCaption'>        updateDatetimeCaption: function() {
</span>            var t = moment(this.getDateTime());
            this.datePickControl.caption.innerHTML = t.format('dddd'); // weekday text
            if (this.showTimePicker)
            {
                this.timePickControl.caption.innerHTML = t.format(this.timeFormatText);
            }
        },
<span id='argos-Views-DateTimePicker-method-getDateTime'>        getDateTime: function() {
</span>            var result = moment(this.date),
                isPM = this.is24hrTimeFormat ? (11 &lt; this.hourNode.value) : domAttr.get(this.meridiemNode, 'toggled') !== true,
                hours = parseInt(this.hourNode.value, 10),
                minutes = parseInt(this.minuteNode.value, 10);

            hours = isPM
                ? (hours % 12) + 12
                : (hours % 12);

            result.hours(hours);
            result.minutes(minutes);
            if ((this.options &amp;&amp; this.options.timeless) || this.timeless)
            {
                result = result.sod().add({minutes: -1 * result.zone(), seconds: 5});
            }

            return result.toDate();
        }
    });
});</pre>
</body>
</html>
