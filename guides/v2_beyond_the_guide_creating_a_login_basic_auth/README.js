Ext.data.JsonP.v2_beyond_the_guide_creating_a_login_basic_auth({"guide":"<h2>Creating a Login Page: Authentication (Basic Auth)</h2>\n\n<p>This exercise will setup a login page and send the credentials using Basic Authentication which will be stored for future SData requests.</p>\n\n<p>1. In <code>argos-template/src/Views</code> create a new file named <code>Login.js</code></p>\n\n<p>2. Define the module and inherit the base Edit View</p>\n\n<pre><code>define('Mobile/SalesLogix/Views/Login', [\n    'dojo/_base/declare',\n    'Sage/Platform/Mobile/Edit'\n], function(\n    declare,\n    Edit\n) {\n    return declare('Mobile.SalesLogix.Views.Login', [Edit], {\n    });\n});\n</code></pre>\n\n<p>3. Add a button element to the <code>widgetTemplate</code>, while normally we would add a toolbar item for actions like this a Login page doesn't look quite right without a big ol' Login button.</p>\n\n<pre><code>        widgetTemplate: new Simplate([\n            '&lt;div id=\"{%= $.id %}\" title=\"{%: $.titleText %}\" class=\"panel {%= $.cls %}\" hideBackButton=\"true\"&gt;',\n            '&lt;div class=\"panel-content\" data-dojo-attach-point=\"contentNode\"&gt;&lt;/div&gt;',\n            '&lt;button class=\"button actionButton\" data-action=\"authenticate\"&gt;&lt;span&gt;{%: $.logOnText %}&lt;/span&gt;&lt;/button&gt;',\n            '&lt;/div&gt;'\n        ]),\n</code></pre>\n\n<p>4. Pointers:</p>\n\n<pre><code>* Use of variables for text strings. This is so localization modules can override the values, no hard-coded strings should be displayed to the user.\n* `hideBackButton=\"true\"` on a View you can add this attr to the main div to remove the back button.\n* `&lt;button&gt;` elements have fuzzy touch areas on phones increasing usability\n* `data-action=\"function\"` place this attribute on any element to have it respond to `onclick` events. The corresponding function name will then be fired in that views' context.\n</code></pre>\n\n<p>5. Add the localizable text variables:</p>\n\n<pre><code>        logOnText: 'Log On',\n        titleText: 'My App',\n</code></pre>\n\n<p>6. Add the view properties id to login and busy to false. The busy flag is for Edit views and is tied to their <code>enable()</code> and <code>disable()</code> functions for controlling user interactions.</p>\n\n<pre><code>        id: 'login',\n        busy: false,\n</code></pre>\n\n<p>7. Empty the toolbars, no need for any buttons</p>\n\n<pre><code>        createToolLayout: function() {\n            return this.tools || (this.tools = {\n                bbar: false,\n                tbar: false\n            });\n        },\n</code></pre>\n\n<p>8. Create the layout with our login fields</p>\n\n<pre><code>        createLayout: function() {\n            return this.layout || (this.layout = [\n                {\n                    name: 'username',\n                    label: this.userText,\n                    type: 'text'\n                },\n                {\n                    name: 'password',\n                    label: this.passText,\n                    type: 'text',\n                    inputType: 'password'\n                }\n            ]);\n        },\n</code></pre>\n\n<p>9. Add the <code>authenticate</code> handler for the button:</p>\n\n<pre><code>        authenticate: function () {\n            if (this.busy) return;\n\n            var credentials = this.getValues(),\n                username = credentials &amp;&amp; credentials.username;\n\n            if (username &amp;&amp; /\\w+/.test(username))\n                this.validateCredentials(credentials);\n        },\n</code></pre>\n\n<p>10. Feel free to expand the username/password check before firing a request, the above makes sure we have a name that is not just spaces.</p>\n\n<p>11. Add the <code>validateCredentials</code> function</p>\n\n<pre><code>        validateCredentials: function (credentials) {\n            this.disable();\n            App.authenticateUser(credentials, {\n                success: function(result) {\n                    this.enable();\n                    App.navigateToInitialView();\n                },\n                failure: function(result) {\n                    this.enable();\n                    if (result.response.status == 403)\n                        alert(this.invalidUserText);\n                    else\n                        alert(this.serverProblemText);\n                },\n                scope: this\n            });\n        }\n</code></pre>\n\n<p>12. What the above does is disable the view (so no interactions) and pass along to the Application level authenticate user (we will add this soon), which is a wrapper for a SData request and as such it takes the normal SData request callback options.</p>\n\n<p>13. Before we leave <code>Login.js</code> lets go back and add the rest of the localizable strings for our fields and messages</p>\n\n<pre><code>        logOnText: 'Log On',\n        passText: 'password',\n        titleText: 'My App',\n        userText: 'user name',\n        invalidUserText: 'The user name or password is invalid.',\n        serverProblemText: 'A problem occured on the server.',\n</code></pre>\n\n<p>14. Now go into <code>src/Application.js</code> and let's add the <code>authenticateUser(credentials, options)</code> function.</p>\n\n<pre><code>        authenticateUser: function(credentials, options) {\n            var service = this.getService()\n                .setUserName(credentials.username)\n                .setPassword(credentials.password || '');\n\n            var request = new Sage.SData.Client.SDataServiceOperationRequest(service)\n                .setContractName('system')\n                .setOperationName('getCurrentUser');\n\n            request.execute({}, {\n                success: lang.hitch(this, this.onAuthenticateUserSuccess, credentials, options.success, options.scope),\n                failure: lang.hitch(this, this.onAuthenticateUserFailure, options.failure, options.scope),\n                aborted: lang.hitch(this, this.onAuthenticateUserFailure, options.failure, options.scope)\n            });\n        },\n</code></pre>\n\n<p>15. The key point here is that it is creating a <code>Sage.SData.Client.SDataServiceOperationRequest</code> and in the case of SalesLogix SData using the <code>system</code> contract and the <code>getCurrentUser</code> operation which ends up looking like:</p>\n\n<pre><code>http://localhost/sdata/slx/system/-/$service/getCurrentUser?format=json\n</code></pre>\n\n<p>It is also important to note that the <code>getService()</code> calls returns the <em>instance</em> of the service meaning any changes will affect all future use of the service. Here was are setting the username and password meaning all future calls with this service will use this credential.</p>\n\n<p>16. To process the returned response we have the <code>onAuthenticateUserSuccess</code> function which is passed the <code>credentials</code>, <code>options.success</code> callback and <code>options.scope</code>. It's last parameter will be the SData result as <code>dojo.hitch</code> prepends the argument list.</p>\n\n<pre><code>        onAuthenticateUserSuccess: function(credentials, callback, scope, result) {\n            var user = {\n                '$key': lang.trim(result['response']['userId']),\n                '$descriptor': result['response']['prettyName'],\n                'UserName': result['response']['userName']\n            };\n\n            this.context['user' ] = user;\n            this.context['roles'] = result['response']['roles'];\n            this.context['securedActions'] = result['response']['securedActions'];\n\n            if (this.context['securedActions'])\n            {\n                array.forEach(this.context['securedActions'], function(item) {\n                    this[item] = true;\n                }, (this.context['userSecurity'] = {}));\n            }\n\n            if (callback)\n                callback.call(scope || this, {user: user});\n        },\n</code></pre>\n\n<p>17. That's a lot of code but it really breaks down to three parts:</p>\n\n<p>   1. Parse the response to get the Users details and store that information into the App.context object</p>\n\n<p>   2. Flatten the securedActions array into an object for quicker lookups</p>\n\n<p>   3. Call the callback, which passes control back over to <code>Login.js</code>, where it gets <code>enable()</code>ed and calls <code>App.navigateToInitialView()</code>.</p>\n\n<pre><code>  * Implementation of parsing the user details and security will differ on your SData provider.\n</code></pre>\n\n<p>18. When authentication fails we want to remove the user/pass from the service instance just to be on the safe side:</p>\n\n<pre><code>        onAuthenticateUserFailure: function(callback, scope, response) {\n            var service = this.getService();\n            if (service)\n                service\n                    .setUserName(false)\n                    .setPassword(false);\n\n            if (callback)\n                callback.call(scope || this, {response: response});\n        },\n</code></pre>\n\n<p>19. In which the callback will alert the user with an error message as defined in <code>Login.js</code>.</p>\n\n<p>20. Before we go and test we need to make sure that the login page is the first one shown instead of the home page.</p>\n\n<p>21. Still in <code>Application.js</code> at the very bottom create the function <code>navigateToLoginView</code> and have it show our login view:</p>\n\n<pre><code>        navigateToLoginView: function() {\n            var view = this.getView('login');\n            if (view)\n                view.show();\n        }\n</code></pre>\n\n<p>22. Scroll up to the <code>run()</code> function and change the navigate to home to navigate to login:</p>\n\n<pre><code>        run: function() {\n            this.inherited(arguments);\n            this.navigateToLoginView();\n        },\n</code></pre>\n\n<p>23. We now need to undo the hard coded userName and password that was added in <a href=\"#!/guide/v2_template_guide\">Argos-Template Guide</a>.</p>\n\n<p>24. Open <code>argos-template/configuration/development.js</code> and remove the <code>userName</code> and <code>password</code> keys from the <code>crm</code> service.</p>\n\n<p>23. Save and run your app, logging in with a valid user (example: \"lee\" no pass).</p>\n\n<p>24. To verify, after logging in type in the console: <code>App.context.user</code> and make sure you see the returned information.</p>\n\n<p>You now have a working authentication system with login page. This could be further expanded with a remember me (storing credentials), or any other hooks you need for getting the initial user information. From here all the List, Detail and Edit views are \"live\" meaning you can set their view properties to point to various SData endpoints.</p>\n","title":"Login Page with Basic Auth"});